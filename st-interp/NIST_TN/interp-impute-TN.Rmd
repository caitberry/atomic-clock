---
title: "Clock data interpolation TN draft"
author: "Thornton"
output:
  word_document:
bibliography: References.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(MASS)
```


<!--- Open Command Palette: Press F1 or Ctrl + Shift + P to open the command palette.
Run Knit Command: Type rmarkdown: Render and select the desired output format (e.g., HTML, PDF).--->
# Introduction

The purpose of this report is to present a methodological approach for applying imputation and interpolation techniques to clock frequency data. This report is a result of collaborative research into statistical methods for the analysis of high-precision atomic clock data by the Statistical Engineering Division of the Information Technology Laboratory and the Time and Frequency Division of the Physical Measurement Laboratory. 

Because of the high precision in observed data, the reproducible estimation of, say, atomic clock frequency ratios requires careful attention to data processing steps. The idiosyncrasies of processing clock data that we focus on in this report options for the treatment of missing data and for the comparison of low frequency data to high frequency data. We describe the nature of these challenges with supporting examples and we present recommendations for addressing these challenges in a transparent, reproducible manner.      


## Audience

## Collaborators  

## Report Organization 
The next section presents some background information and an example to provide context for the problem at hand. Section 3 discusses the initial necessary data exploration steps, Section 4 covers interpolation methods for handling multiple, misaligned data sets, and Section 5 concludes by summarizing the steps needed to produce a coherent final data set for estimation and inference. 


<!-------------------------------------------------------------->
# Background 

The challenge presented here has several layers that complicate a traditional time series analysis. Although the ultimate analysis is of a single time series, let's call this the target series, the target series is computed based on calculations involving at least three individual time series, we will call these sub-series. Each sub-series is independent of the other(s) but each may contain missing values and is irregularly sampled, possibly at very different frequencies. Furthermore, the sub-series may have slightly or dramatically different start and end times. 

The application that motivates this article is the analysis of atomic clock ratio data. 

[Background on existing approaches for combining time series i.e. convolution of time series]

[Background on existing methods for univariate time series imputation] @howe2021, @pavia2010, @lepot2017

[Background on existing work mapping low frequency series to high frequency one. AKA mixed frequency data analysis] 

[Background on existing work on irregularly samples time series.] @shukla2019 @nieto2015 @erdogan2005

[Mention and reference work on spectral analysis of time series for atomic clock data] In this article, we restrict our focus to analysis in the time domain. In the example application of atomic clock ratio data, the results of interest include estimates of the mean and Allan deviation of the target series. 

<!-------------------------------------------------------------->
# Data Exploration

## Visualize Missing Data 

Data visualization is an important first step to identify any missing data or unexpected patterns. It is crucial that individual time series are visualized before they are combined. This step also helps with the determination of identifying the overlapping window of observations which is the topic of the next section. 

To understand the magnitude of any missing data issues, one can count the missing observations in each time series. For example, the following Python code reports the total number of missing data points (i.e. truly empty or null data values). 

```{python, eval=FALSE, echo=TRUE}
missing_index = pd.isnull(time_series_data)
print(missing_index.sum())
```

While this numerical summary of missing values is informative, it is not enough to identify any unusual patterns of missingness. For this, there is no substitute for a visual analysis of the data. A useful Python package for visualizing missing data is the package "missingno" which can be implemented as follows. 

```{python, eval=FALSE, echo=TRUE}
import missingno as msno

msno.matrix(time_series_data)
plt.show()
```

The treatment of long sequences of missing data is distinct from the treatment of individual missing data points. While common imputation techniques for univariate time series [cite sources] can be implemented for individual missing values, long sequences of missing values indicate a need to reconsider the start and end times for each sub-series. Large gaps of missing data must be factored in to the next step where one decides which window of observations to analyze in the target series. This is the topic of the next section.   

[Add note of caution about how keeping missing data until end is not advisable.] 

## Determine Overlapping Window of Observation 



An important characteristic of clock and comb data is that the beginning and end point of observations may vary among each sub-series. If there are any large gaps of missing data in the clock shift files, this should also be taken into consideration when determining the start and end time points of the data. Therefore, a necessary component to preparing the data for analysis is first identifying the overlapping windows of observation for each time series. The goal of this step is to find a time interval $[t_{i}, t_{j}]$ that includes the largest possible intersection of non-missing observations from each sub-series. 

Consider the figure below which marks the start and end points of observations for three sub-series, a time series of comb data, a time series from two different atomic clocks. If there are no large gaps of missing values in any of these series, the largest window of observation for the target series (which in this case is a ratio of the two clock values) begins at the first time point of the comb series and ends at the last time point of Clock 1's series. Even though there are more observations outside of this range, these observations cannot be used because values from all three time series are necessary to construct the target series.  

```{r, echo=FALSE}
library(ggplot2) 
x <- 60535
comb <- c(x + 0.71, x + 0.92)
al <- c(x + 0.6818403, x + 0.9108218 )
sr <- c(x + 0.705143550906, x + 0.9791847021)
df <- data.frame(c("Clock 1", "Clock 2", "Comb"), rbind(al, sr, comb))
colnames(df) <- c("Series", "start", "end")
rownames(df) <- NULL
df_plot <- data.frame(Series = rep(df$Series,2), time = c(df$start, df$end)) 

ggplot(df_plot) +
  geom_point(aes(x=time, y=0, color=Series), size = 15, shape="|", alpha=0.7)  +
  annotate("segment", x=min(df$start)-0.01, xend=max(df$end)+0.01, y=0, yend=0, linewidth=1) +
#  annotate("segment", x=min(df$start)-0.01, xend=min(df$start)-0.01, y=-0.0001, yend=0.0001, linewidth=2) +
#  annotate("segment", x=max(df$end)+0.01, xend=max(df$end)+0.01, y=-0.0001, yend=0.0001, linewidth=2) +
#  geom_text(aes(label = x), col="white") +
  scale_x_continuous(limits = c(min(df$start)-0.01, max(df$end)+0.01)) +
  scale_y_continuous(limits = c(-0.001,0.001)) +
#  scale_color_manual(values = unname(colours)) + 
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

For this reason, the target time series cannot be computed over any time intervals containing sequentially missing values for one or more of the sub-series. It is more accurate in such cases to consider data before and after a large gap as separate time series with smaller sample sizes. Thus, in the case where a sub-series contains at least one large gap of missing values, the final overlapping window of observation will be considerably smaller as will the target series sample size. [Reiterate note about how keeping missing values until the end is not a valid approach - even if it can be computed with software.]   

In addition to visualizing the sub-series, the follow Python functions may be useful for detecting the overlapping window of observation for the target series. 

```{python, eval=FALSE, echo=TRUE}
# Extracts series element that is as close to the target as possible without going over.
def lb_extract(target, data):
    inx = 0
    stopper = 1
    while stopper == 1:
        if data[inx] <= target:
            inx += 1
        else:
            return inx  

# Extracts series element that is as close to target as possible without going under.  
def ub_extract(target, data):
    inx = 1
    stopper = 1
    while stopper == 1:
        if data[len(data)-inx] >= target:
            inx += 1
        else:
            return len(data)-inx 
```


<!-------------------------------------------------------------->
# Interpolation 


## Frequency Alignment

The culmination of the previous data processing steps yields several independent sub-series that begin and end at the same time points but that may be observed with very different frequencies. At this stage, there is no missing data in any of the sub-series; however, because each series is comprised of observations along an irregular time scale, we are not yet ready to compute the target series. In the context of atomic clock data, the comb time series are typically observed more regularly than any individual clock shift time series. Thus the comb data represent a high-frequency sub-series and the clock shift data are low-frequency sub-series in comparison. Furthermore, it may be the case that each clock sub-series is sampled at very different rates. 

Without loss of generality and for the sake of illustration, let us suppose that we are constructing a target series from a comb sub-series and two clock sub-series. Suppose further that Clock 1 is observed with either a similar or lower frequency than Clock 2 and Clock 2 is observed with a similar frequency as the comb sub-series. To derive a ratio time series for any two clocks, the time points of observations for sub-series must be in alignment with one another. Here we give an overview of several methodological approaches one may take to align all three series.

**Method 1**: Align Clock 1 with the observations of the comb. Then align Clock 2 with the observations of the comb. Proceed to derive the ratio time series for analysis. The result of this approach will be a time series with the same irregularities in sampling as the comb series.  

**Method 2**: Align Clock 1 with the observations of Clock 2. Then align the new series for Clock 1 with the comb. Finally, align Clock 2 with the comb and proceed to derive the ratio time series for analysis. This approach may be reasonable if Clock 1 is observed with a much lower frequency compared to Clock 2. As with Method 1, the result will be a time series with the same irregular observation pattern as the comb data.  

**Method 3**: Realign the comb time series so that the observations are regularly sampled along the time interval of interest. Align Clock 1 with the new, regularly observed comb series. Align Clock 2 with the new, regularly observed comb series. Proceed to derive the ratio time series for analysis. The result of this approach will be a regularly sampled time series.  

**Method 4**: Align clock A with the observations of clock B. Then align the comb with clock B. Proceed to derive the ratio time series for analysis. The result of this approach will be a time series with the same irregularities in sampling as the series of observations from clock B. This approach essentially disregards or masks comb data for the sake of matching the observational time points of clock B. 

**Method 5**: Realign the time series from clock B so that the observations are regularly sampled along the time interval of interest. Align clock A with the new, regularly observed series from clock B. Align the comb with the new, regularly observed series from clock B. Proceed to derive the ratio time series for analysis. The result of this approach will be a regularly sampled time series. 

Note that none of the methods listed above suggest realigning a high frequency series to match a low frequency series. This is because such an approach would sacrifice valuable information contained in the higher frequency series and is generally not advisable. Although it is listed above for the sake of completeness, Method 2 is inferior to the other methods because it results in an irregularly sampled time series and it requires three separate interpolation steps. In comparison, Methods 1 and 2 only require two separate interpolation steps. The drawback of these two methods however is that the resulting time series is still irregularly observed. Methods 3 and 5 on the other hand, each require three separate interpolation steps, but the result is a regularly sampled time series. 

Depending on the type of analysis, having an irregularly sampled time series may or may not be of concern. For example, if the analysis is based upon a multitaper spectral approach such as that in [cite clock paper], then the sampling irregularities do not present an issue. [cite sources as to why not]. However, if the analysis is to proceed in [the time domain?], irregularities in the observational frequency of the time series will bias common estimates of interest such as the mean and AVAR. [cite sources] 

## Interpolation techniques 



Once a method for alignment is determined, the implementation of the alignment will occur through time series interpolation. There are many different techniques for interpolating time series data. [Cite some sources.]  

<!-------------------------------------------------------------->
# Conclusion 

The process we have outlined for aligning the observational frequency of clock time series follows these steps: 

Step 1) Process the data for each time series to determine the final window of observation and exclude low-quality data. 

Step 2) Determine if there are any missing data and decide whether or not to impute values that are missing. 

Step 3) Determine which method of frequency alignment will be used and decide upon an interpolation technique to implement the alignment. 

Calculate clock frequencies by adding together comb frequencies and shift data, scaled by the total correction amount 

[all of this analysis is occurring within the time domain? not the frequency domain?] 



